version: 2.1


executors:
  jest-executor:
    docker:
      - image: cimg/node:20.11.0
    resource_class: medium

  cypress-executor:
    docker:
      - image: cimg/node:20.11.0-browsers
    resource_class: large

  postgres-executer:
    docker:
      - image: cimg/node:20.11.0
      - image: cimg/postgres:12.7
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD:
    resource_class: medium

jobs:
  db-migration:
    executor: postgres-executer
    steps:
      - checkout
      - run: npm install -g db-migrate
      - run:
          name: Install PostgreSQL client and setup database
          command: |
            sudo apt-get update
            sudo apt-get install postgresql-client
            createdb -h localhost d4adlocal -U postgres
            DB_ENV=$DB_ENV scripts/db-migrate.sh

  jest-tests:
    executor: jest-executor
    steps:
      - checkout
      - run: npm ci
      - run: scripts/test-all.sh

  cypress-tests:
    executor: cypress-executor
    steps:
      - checkout
      - run:
          name: Install UI dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository universe
            sudo apt-get update
            sudo apt-get install -y \
              libgtk2.0-0 \
              libgtk-3-0 \
              libgbm-dev \
              libnotify-dev \
              libgconf-2-4 \
              libnss3 \
              libxss1 \
              libasound2 \
              libxtst6 \
              xauth \
              xvfb
      - run: scripts/feature-tests.sh > feature-test-output.txt
      - store_artifacts:
          path: feature-test-output.txt

workflows:
  build-test-migrate:
    jobs:
      - db-migration
      - jest-tests
      - cypress-tests
